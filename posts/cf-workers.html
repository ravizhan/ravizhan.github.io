<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
<script>var OriginTitile=document.title;
 var st;
 document.addEventListener('visibilitychange',function(){
 if(document.hidden){
 document.title="(つェ⊂)浏览器崩溃了";
 clearTimeout(st);
 }else{
 document.title='(*´∇｀*)吖~又好了~ '+OriginTitile;
 st=setTimeout(function(){
 document.title=OriginTitile;
 },4000);
 }
 });</script>
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="tUjCdPI62W">
<meta name="sogou_site_verification" content="p6j7spo07w"/>

  <meta name="keywords" content="Ravi,Ravi's blog" />

<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.ravi.cool","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Cloudflare Workers的使用及相关示例">
<meta property="og:type" content="article">
<meta property="og:title" content="cf-workers的使用">
<meta property="og:url" content="https://www.ravi.cool/posts/cf-workers.html">
<meta property="og:site_name" content="Ravi&#39;s blog">
<meta property="og:description" content="Cloudflare Workers的使用及相关示例">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/creat.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/1.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/2.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/jsproxy.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers-dir.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/GDIndex%20Code%20Builder.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/google.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/code.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/paste.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/root_id.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/GDIndex.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers-domain.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/cf-dns.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/wzf.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/set.jpg">
<meta property="article:published_time" content="2020-08-14T12:25:00.000Z">
<meta property="article:modified_time" content="2020-08-16T03:53:27.894Z">
<meta property="article:author" content="Ravi">
<meta property="article:tag" content="Cloudflare">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/creat.jpg">

<link rel="canonical" href="https://www.ravi.cool/posts/cf-workers.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>cf-workers的使用 | Ravi's blog</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?43b01a651242ec880c4679c4b29548df";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ravi's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ravi的秘密花园</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-download">

    <a href="https://down.ravi.cool/" rel="noopener" target="_blank"><i class="fa fa-fw fa-download"></i>下载站</a>

  </li>
        <li class="menu-item menu-item-daishua">

    <a href="http://fly.troe.top/" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>专业代刷</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
        <li class="menu-item menu-item-friendlink">

    <a href="/friendlink/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.ravi.cool/posts/cf-workers.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/avatar.gif">
      <meta itemprop="name" content="Ravi">
      <meta itemprop="description" content="一个充满知识的地方">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ravi's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cf-workers的使用
        </h1>

        <div class="post-meta">
		  
		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-14 20:25:00" itemprop="dateCreated datePublished" datetime="2020-08-14T20:25:00+08:00">2020-08-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-16 11:53:27" itemprop="dateModified" datetime="2020-08-16T11:53:27+08:00">2020-08-16</time>
              </span>

          
            <span id="/posts/cf-workers.html" class="post-meta-item leancloud_visitors" data-flag-title="cf-workers的使用" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/cf-workers.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/cf-workers.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>
            <div class="post-description">Cloudflare Workers的使用及相关示例</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="what’s-cf-workers"><a href="#what’s-cf-workers" class="headerlink" title="what’s cf-workers"></a>what’s cf-workers</h2><p>Cloudflare Workers允许你在Cloudflare的边缘节点运行JS, Rust, C, C++等代码<br>并且每天有100,000次的免费请求，对于绝大多数人来说，是完全够用的<br>具体介绍见Cloudflare Workers官网：<a href="https://workers.cloudflare.com/" target="_blank" rel="noopener">https://workers.cloudflare.com/</a></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><blockquote>
<p>没有 Cloudflare 账号的提前注册一个</p>
</blockquote>
<p>打开 <a href="https://workers.cloudflare.com" target="_blank" rel="noopener">https://workers.cloudflare.com</a> ,登录上你的 Cloudflare 账号,激活 Workers 服务<br>然后自定义一个域名前缀，就可以啦</p>
<p>点击<code>创建Worker</code>就可以新建一个worker了<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/creat.jpg" width = "60%" /><br>点击这里就可以自定义worker的域名的前缀啦<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/1.jpg" width = "60%" /><br>然后在中间编写代码，最后点击<code>保存并部署</code>，就完成部署了<br>最后的访问地址是：<a href="https://worker前缀.一开始自定义的前缀.workers.dev，或者返回也能看见访问地址了" target="_blank" rel="noopener">https://worker前缀.一开始自定义的前缀.workers.dev，或者返回也能看见访问地址了</a><br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/2.jpg" width = "60%" /></p>
<h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><blockquote>
<p>是不是很简单呢，下面有一些实用的代码，可以部署来玩玩</p>
</blockquote>
<h3 id="workers-proxy"><a href="#workers-proxy" class="headerlink" title="workers-proxy"></a>workers-proxy</h3><blockquote>
<p>这个代码理论上可以实现反代任意网站<br>不知道反向代理的 <a href="https://url.cn/tMaCMpgn" target="_blank" rel="noopener">https://url.cn/tMaCMpgn</a><br>github: <a href="https://github.com/xiaoyang-liu-cs/workers-proxy" target="_blank" rel="noopener">https://github.com/xiaoyang-liu-cs/workers-proxy</a></p>
</blockquote>
<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要进行反向代理的网站</span></span><br><span class="line"><span class="keyword">const</span> upstream = <span class="string">'example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 要进行代理的路径(一般不用改)</span></span><br><span class="line"><span class="keyword">const</span> upstream_path = <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 要进行反向代理的网站的移动站(一般跟上面一样就行)</span></span><br><span class="line"><span class="keyword">const</span> upstream_mobile = <span class="string">'example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 你希望禁止访问的国家/地区</span></span><br><span class="line"><span class="keyword">const</span> blocked_region = [<span class="string">'KP'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你希望禁止访问的ip</span></span><br><span class="line"><span class="keyword">const</span> blocked_ip_address = [<span class="string">'127.0.0.1'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否使用https与源站连接(一般不用改，现在大部分网站都支持https了)</span></span><br><span class="line"><span class="keyword">const</span> https = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换文本</span></span><br><span class="line"><span class="keyword">const</span> replace_dict = &#123;</span><br><span class="line">    <span class="string">'$upstream'</span>: <span class="string">'$custom_domain'</span>,</span><br><span class="line">    <span class="string">'//www.youtube.com'</span>: <span class="string">''</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addEventListener(<span class="string">'fetch'</span>, event =&gt; &#123;</span><br><span class="line">    event.respondWith(fetchAndApply(event.request));</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchAndApply</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> region = request.headers.get(<span class="string">'cf-ipcountry'</span>).toUpperCase();</span><br><span class="line">    <span class="keyword">const</span> ip_address = request.headers.get(<span class="string">'cf-connecting-ip'</span>);</span><br><span class="line">    <span class="keyword">const</span> user_agent = request.headers.get(<span class="string">'user-agent'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> response = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">    <span class="keyword">let</span> url_hostname = url.hostname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (https == <span class="literal">true</span>) &#123;</span><br><span class="line">        url.protocol = <span class="string">'https:'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        url.protocol = <span class="string">'http:'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> device_status(user_agent)) &#123;</span><br><span class="line">        <span class="keyword">var</span> upstream_domain = upstream;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> upstream_domain = upstream_mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    url.host = upstream_domain;</span><br><span class="line">    <span class="keyword">if</span> (url.pathname == <span class="string">'/'</span>) &#123;</span><br><span class="line">        url.pathname = upstream_path;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        url.pathname = upstream_path + url.pathname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (blocked_region.includes(region)) &#123;</span><br><span class="line">        response = <span class="keyword">new</span> Response(<span class="string">'Access denied: WorkersProxy is not available in your region yet.'</span>, &#123;</span><br><span class="line">            status: <span class="number">403</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (blocked_ip_address.includes(ip_address)) &#123;</span><br><span class="line">        response = <span class="keyword">new</span> Response(<span class="string">'Access denied: Your IP address is blocked by WorkersProxy.'</span>, &#123;</span><br><span class="line">            status: <span class="number">403</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> method = request.method;</span><br><span class="line">        <span class="keyword">let</span> request_headers = request.headers;</span><br><span class="line">        <span class="keyword">let</span> new_request_headers = <span class="keyword">new</span> Headers(request_headers);</span><br><span class="line"></span><br><span class="line">        new_request_headers.set(<span class="string">'Host'</span>, url.hostname);</span><br><span class="line">        new_request_headers.set(<span class="string">'Referer'</span>, url.hostname);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> original_response = <span class="keyword">await</span> fetch(url.href, &#123;</span><br><span class="line">            method: method,</span><br><span class="line">            headers: new_request_headers</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> original_response_clone = original_response.clone();</span><br><span class="line">        <span class="keyword">let</span> original_text = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> response_headers = original_response.headers;</span><br><span class="line">        <span class="keyword">let</span> new_response_headers = <span class="keyword">new</span> Headers(response_headers);</span><br><span class="line">        <span class="keyword">let</span> status = original_response.status;</span><br><span class="line"></span><br><span class="line">        new_response_headers.set(<span class="string">'access-control-allow-origin'</span>, <span class="string">'*'</span>);</span><br><span class="line">        new_response_headers.set(<span class="string">'access-control-allow-credentials'</span>, <span class="literal">true</span>);</span><br><span class="line">        new_response_headers.delete(<span class="string">'content-security-policy'</span>);</span><br><span class="line">        new_response_headers.delete(<span class="string">'content-security-policy-report-only'</span>);</span><br><span class="line">        new_response_headers.delete(<span class="string">'clear-site-data'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> content_type = new_response_headers.get(<span class="string">'content-type'</span>);</span><br><span class="line">        <span class="keyword">if</span> (content_type.includes(<span class="string">'text/html'</span>) &amp;&amp; content_type.includes(<span class="string">'UTF-8'</span>)) &#123;</span><br><span class="line">            original_text = <span class="keyword">await</span> replace_response_text(original_response_clone, upstream_domain, url_hostname);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            original_text = original_response_clone.body</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response = <span class="keyword">new</span> Response(original_text, &#123;</span><br><span class="line">            status,</span><br><span class="line">            headers: new_response_headers</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">replace_response_text</span>(<span class="params">response, upstream_domain, host_name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> text = <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> replace_dict) &#123;</span><br><span class="line">        j = replace_dict[i]</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="string">'$upstream'</span>) &#123;</span><br><span class="line">            i = upstream_domain</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="string">'$custom_domain'</span>) &#123;</span><br><span class="line">            i = host_name</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (j == <span class="string">'$upstream'</span>) &#123;</span><br><span class="line">            j = upstream_domain</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="string">'$custom_domain'</span>) &#123;</span><br><span class="line">            j = host_name</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(i, <span class="string">'g'</span>)</span><br><span class="line">        text = text.replace(re, j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">device_status</span>(<span class="params">user_agent_info</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> agents = [<span class="string">"Android"</span>, <span class="string">"iPhone"</span>, <span class="string">"SymbianOS"</span>, <span class="string">"Windows Phone"</span>, <span class="string">"iPad"</span>, <span class="string">"iPod"</span>];</span><br><span class="line">    <span class="keyword">var</span> flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> v = <span class="number">0</span>; v &lt; agents.length; v++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (user_agent_info.indexOf(agents[v]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div>

<p>将上面的两处<code>example.com</code>改成你想要进行反代的网站域名即可</p>
<h3 id="jsproxy"><a href="#jsproxy" class="headerlink" title="jsproxy"></a>jsproxy</h3><blockquote>
<p>该源码可实现在线代理(翻墙)<br>不是所有网站可用<br>github:<a href="https://github.com/EtherDream/jsproxy" target="_blank" rel="noopener">https://github.com/EtherDream/jsproxy</a></p>
</blockquote>
<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * static files (404.html, sw.js, conf.js)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ASSET_URL = <span class="string">'https://etherdream.github.io/jsproxy'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> JS_VER = <span class="number">10</span></span><br><span class="line"><span class="keyword">const</span> MAX_RETRY = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;RequestInit&#125;</span> </span>*/</span></span><br><span class="line"><span class="keyword">const</span> PREFLIGHT_INIT = &#123;</span><br><span class="line">  status: <span class="number">204</span>,</span><br><span class="line">  headers: <span class="keyword">new</span> Headers(&#123;</span><br><span class="line">    <span class="string">'access-control-allow-origin'</span>: <span class="string">'*'</span>,</span><br><span class="line">    <span class="string">'access-control-allow-methods'</span>: <span class="string">'GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS'</span>,</span><br><span class="line">    <span class="string">'access-control-max-age'</span>: <span class="string">'1728000'</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;any&#125;</span> <span class="variable">body</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number&#125;</span> <span class="variable">status</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Object&lt;string, string&gt;&#125;</span> <span class="variable">headers</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeRes</span>(<span class="params">body, status = <span class="number">200</span>, headers = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  headers[<span class="string">'--ver'</span>] = JS_VER</span><br><span class="line">  headers[<span class="string">'access-control-allow-origin'</span>] = <span class="string">'*'</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(body, &#123;status, headers&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>urlStr </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newUrl</span>(<span class="params">urlStr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> URL(urlStr)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">addEventListener(<span class="string">'fetch'</span>, e =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ret = fetchHandler(e)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> makeRes(<span class="string">'cfworker error:\n'</span> + err.stack, <span class="number">502</span>))</span><br><span class="line">  e.respondWith(ret)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;FetchEvent&#125;</span> </span>e </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchHandler</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> req = e.request</span><br><span class="line">  <span class="keyword">const</span> urlStr = req.url</span><br><span class="line">  <span class="keyword">const</span> urlObj = <span class="keyword">new</span> URL(urlStr)</span><br><span class="line">  <span class="keyword">const</span> path = urlObj.href.substr(urlObj.origin.length)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (urlObj.protocol === <span class="string">'http:'</span>) &#123;</span><br><span class="line">    urlObj.protocol = <span class="string">'https:'</span></span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">''</span>, <span class="number">301</span>, &#123;</span><br><span class="line">      <span class="string">'strict-transport-security'</span>: <span class="string">'max-age=99999999; includeSubDomains; preload'</span>,</span><br><span class="line">      <span class="string">'location'</span>: urlObj.href,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (path.startsWith(<span class="string">'/http/'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> httpHandler(req, path.substr(<span class="number">6</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (path) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'/http'</span>:</span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">'请更新 cfworker 到最新版本!'</span>)</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'/ws'</span>:</span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">'not support'</span>, <span class="number">400</span>)</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'/works'</span>:</span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">'it works'</span>)</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// static files</span></span><br><span class="line">    <span class="keyword">return</span> fetch(ASSET_URL + path)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Request&#125;</span> <span class="variable">req</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">pathname</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpHandler</span>(<span class="params">req, pathname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reqHdrRaw = req.headers</span><br><span class="line">  <span class="keyword">if</span> (reqHdrRaw.has(<span class="string">'x-jsproxy'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Response.error()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// preflight</span></span><br><span class="line">  <span class="keyword">if</span> (req.method === <span class="string">'OPTIONS'</span> &amp;&amp;</span><br><span class="line">      reqHdrRaw.has(<span class="string">'access-control-request-headers'</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="literal">null</span>, PREFLIGHT_INIT)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> acehOld = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> rawSvr = <span class="string">''</span></span><br><span class="line">  <span class="keyword">let</span> rawLen = <span class="string">''</span></span><br><span class="line">  <span class="keyword">let</span> rawEtag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> reqHdrNew = <span class="keyword">new</span> Headers(reqHdrRaw)</span><br><span class="line">  reqHdrNew.set(<span class="string">'x-jsproxy'</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处逻辑和 http-dec-req-hdr.lua 大致相同</span></span><br><span class="line">  <span class="comment">// https://github.com/EtherDream/jsproxy/blob/master/lua/http-dec-req-hdr.lua</span></span><br><span class="line">  <span class="keyword">const</span> refer = reqHdrNew.get(<span class="string">'referer'</span>)</span><br><span class="line">  <span class="keyword">const</span> query = refer.substr(refer.indexOf(<span class="string">'?'</span>) + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">'missing params'</span>, <span class="number">403</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> param = <span class="keyword">new</span> URLSearchParams(query)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [k, v] <span class="keyword">of</span> <span class="built_in">Object</span>.entries(param)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (k.substr(<span class="number">0</span>, <span class="number">2</span>) === <span class="string">'--'</span>) &#123;</span><br><span class="line">      <span class="comment">// 系统信息</span></span><br><span class="line">      <span class="keyword">switch</span> (k.substr(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'aceh'</span>:</span><br><span class="line">        acehOld = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'raw-info'</span>:</span><br><span class="line">        [rawSvr, rawLen, rawEtag] = v.split(<span class="string">'|'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 还原 HTTP 请求头</span></span><br><span class="line">      <span class="keyword">if</span> (v) &#123;</span><br><span class="line">        reqHdrNew.set(k, v)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reqHdrNew.delete(k)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!param.has(<span class="string">'referer'</span>)) &#123;</span><br><span class="line">    reqHdrNew.delete(<span class="string">'referer'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cfworker 会把路径中的 `//` 合并成 `/`</span></span><br><span class="line">  <span class="keyword">const</span> urlStr = pathname.replace(<span class="regexp">/^(https?):\/+/</span>, <span class="string">'$1://'</span>)</span><br><span class="line">  <span class="keyword">const</span> urlObj = newUrl(urlStr)</span><br><span class="line">  <span class="keyword">if</span> (!urlObj) &#123;</span><br><span class="line">    <span class="keyword">return</span> makeRes(<span class="string">'invalid proxy url: '</span> + urlStr, <span class="number">403</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;RequestInit&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">const</span> reqInit = &#123;</span><br><span class="line">    method: req.method,</span><br><span class="line">    headers: reqHdrNew,</span><br><span class="line">    redirect: <span class="string">'manual'</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (req.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">    reqInit.body = req.body</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proxy(urlObj, reqInit, acehOld, rawLen, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;URL&#125;</span> </span>urlObj </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;RequestInit&#125;</span> </span>reqInit </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number&#125;</span> </span>retryTimes </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">urlObj, reqInit, acehOld, rawLen, retryTimes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(urlObj.href, reqInit)</span><br><span class="line">  <span class="keyword">const</span> resHdrOld = res.headers</span><br><span class="line">  <span class="keyword">const</span> resHdrNew = <span class="keyword">new</span> Headers(resHdrOld)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> expose = <span class="string">'*'</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [k, v] <span class="keyword">of</span> resHdrOld.entries()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (k === <span class="string">'access-control-allow-origin'</span> ||</span><br><span class="line">        k === <span class="string">'access-control-expose-headers'</span> ||</span><br><span class="line">        k === <span class="string">'location'</span> ||</span><br><span class="line">        k === <span class="string">'set-cookie'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> x = <span class="string">'--'</span> + k</span><br><span class="line">      resHdrNew.set(x, v)</span><br><span class="line">      <span class="keyword">if</span> (acehOld) &#123;</span><br><span class="line">        expose = expose + <span class="string">','</span> + x</span><br><span class="line">      &#125;</span><br><span class="line">      resHdrNew.delete(k)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (acehOld &amp;&amp;</span><br><span class="line">      k !== <span class="string">'cache-control'</span> &amp;&amp;</span><br><span class="line">      k !== <span class="string">'content-language'</span> &amp;&amp;</span><br><span class="line">      k !== <span class="string">'content-type'</span> &amp;&amp;</span><br><span class="line">      k !== <span class="string">'expires'</span> &amp;&amp;</span><br><span class="line">      k !== <span class="string">'last-modified'</span> &amp;&amp;</span><br><span class="line">      k !== <span class="string">'pragma'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      expose = expose + <span class="string">','</span> + k</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (acehOld) &#123;</span><br><span class="line">    expose = expose + <span class="string">',--s'</span></span><br><span class="line">    resHdrNew.set(<span class="string">'--t'</span>, <span class="string">'1'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// verify</span></span><br><span class="line">  <span class="keyword">if</span> (rawLen) &#123;</span><br><span class="line">    <span class="keyword">const</span> newLen = resHdrOld.get(<span class="string">'content-length'</span>) || <span class="string">''</span></span><br><span class="line">    <span class="keyword">const</span> badLen = (rawLen !== newLen)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (badLen) &#123;</span><br><span class="line">      <span class="keyword">if</span> (retryTimes &lt; MAX_RETRY) &#123;</span><br><span class="line">        urlObj = <span class="keyword">await</span> parseYtVideoRedir(urlObj, newLen, res)</span><br><span class="line">        <span class="keyword">if</span> (urlObj) &#123;</span><br><span class="line">          <span class="keyword">return</span> proxy(urlObj, reqInit, acehOld, rawLen, retryTimes + <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> makeRes(res.body, <span class="number">400</span>, &#123;</span><br><span class="line">        <span class="string">'--error'</span>: <span class="string">`bad len: <span class="subst">$&#123;newLen&#125;</span>, except: <span class="subst">$&#123;rawLen&#125;</span>`</span>,</span><br><span class="line">        <span class="string">'access-control-expose-headers'</span>: <span class="string">'--error'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (retryTimes &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      resHdrNew.set(<span class="string">'--retry'</span>, retryTimes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> status = res.status</span><br><span class="line"></span><br><span class="line">  resHdrNew.set(<span class="string">'access-control-expose-headers'</span>, expose)</span><br><span class="line">  resHdrNew.set(<span class="string">'access-control-allow-origin'</span>, <span class="string">'*'</span>)</span><br><span class="line">  resHdrNew.set(<span class="string">'--s'</span>, status)</span><br><span class="line">  resHdrNew.set(<span class="string">'--ver'</span>, JS_VER)</span><br><span class="line"></span><br><span class="line">  resHdrNew.delete(<span class="string">'content-security-policy'</span>)</span><br><span class="line">  resHdrNew.delete(<span class="string">'content-security-policy-report-only'</span>)</span><br><span class="line">  resHdrNew.delete(<span class="string">'clear-site-data'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (status === <span class="number">301</span> ||</span><br><span class="line">      status === <span class="number">302</span> ||</span><br><span class="line">      status === <span class="number">303</span> ||</span><br><span class="line">      status === <span class="number">307</span> ||</span><br><span class="line">      status === <span class="number">308</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    status = status + <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(res.body, &#123;</span><br><span class="line">    status,</span><br><span class="line">    headers: resHdrNew,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;URL&#125;</span> </span>urlObj </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isYtUrl</span>(<span class="params">urlObj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    urlObj.host.endsWith(<span class="string">'.googlevideo.com'</span>) &amp;&amp;</span><br><span class="line">    urlObj.pathname.startsWith(<span class="string">'/videoplayback'</span>)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;URL&#125;</span> </span>urlObj </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number&#125;</span> </span>newLen </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Response&#125;</span> </span>res </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">parseYtVideoRedir</span>(<span class="params">urlObj, newLen, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (newLen &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isYtUrl(urlObj)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> res.text()</span><br><span class="line">    urlObj = <span class="keyword">new</span> URL(data)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isYtUrl(urlObj)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> urlObj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div>
<p>然后访问自定义的网址即可，是不是很神奇呢<br>后面会介绍如何自定义域名<br>最终效果如图↓<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/jsproxy.jpg" width = "60%" /></p>
<h3 id="CF-Worker-Dir"><a href="#CF-Worker-Dir" class="headerlink" title="CF-Worker-Dir"></a>CF-Worker-Dir</h3><blockquote>
<p>CF-Worker-Dir是一款适用于Cloudflare Worker平台上的云函数程序，可以使用它在一分钟内搭建属于自己的导航页面。<br>github:<a href="https://github.com/sleepwood/CF-Worker-Dir" target="_blank" rel="noopener">https://github.com/sleepwood/CF-Worker-Dir</a></p>
</blockquote>
<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  自定义网站配置 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  title: <span class="string">"自定义导航"</span>,                 <span class="comment">//write your website title</span></span><br><span class="line">  subtitle: <span class="string">"Cloudflare Workers Dir"</span>, <span class="comment">//write your website subtitle</span></span><br><span class="line">  logo_icon: <span class="string">"sitemap"</span>,               <span class="comment">//select your logo by semantic-ui icon (you can get more msg in:https://semantic-ui.com/elements/icon.html)</span></span><br><span class="line">  hitokoto: <span class="literal">true</span>,                     <span class="comment">//use hitokoto or not</span></span><br><span class="line">  search:<span class="literal">true</span>,                        <span class="comment">//enable search function</span></span><br><span class="line">  search_engine:[                     <span class="comment">//choose search engine which you use</span></span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"百 度"</span>,</span><br><span class="line">      template:<span class="string">"https://www.baidu.com/s?wd=$s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"谷 歌"</span>,</span><br><span class="line">      template:<span class="string">"https://www.google.com/search?q=$s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"必 应"</span>,</span><br><span class="line">      template:<span class="string">"https://www.bing.com/search?q=$s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"搜 狗"</span>,</span><br><span class="line">      template:<span class="string">"https://www.sogou.com/web?query=$s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  selling_ads: <span class="literal">true</span>,                  <span class="comment">//Selling your domain or not.(turning on may be helpful for selling this domain by showing some ads.)</span></span><br><span class="line">  sell_info:&#123;</span><br><span class="line">    domain:<span class="string">"example.com"</span>,</span><br><span class="line">    price:<span class="number">500</span>,                        <span class="comment">//domain price</span></span><br><span class="line">    mon_unit:<span class="string">"yen sign"</span>,              <span class="comment">//monetary unit </span></span><br><span class="line">    contact:[                         <span class="comment">//how to contact you</span></span><br><span class="line">      &#123;</span><br><span class="line">        type:<span class="string">"envelope"</span>,               <span class="comment">//contact type ("weixin","qq","telegram plane","envelope" or "phone")</span></span><br><span class="line">        content:<span class="string">"info@example.com"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]                        </span><br><span class="line">  &#125;,</span><br><span class="line">  lists: [                            <span class="comment">//Url list</span></span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"技术"</span>,</span><br><span class="line">      icon:<span class="string">"code"</span>,</span><br><span class="line">      list:[</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://oschina.net/"</span>,</span><br><span class="line">          name:<span class="string">"开源中国"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://v2ex.com"</span>,</span><br><span class="line">          name:<span class="string">"V2EX"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://csdn.net/"</span>,</span><br><span class="line">          name:<span class="string">"CSDN技术社区"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://github.com/"</span>,</span><br><span class="line">          name:<span class="string">"Github"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name:<span class="string">"学习"</span>,</span><br><span class="line">      icon:<span class="string">"graduation cap"</span>,</span><br><span class="line">      list:[</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://w3school.com.cn/"</span>,</span><br><span class="line">          name:<span class="string">"W3school在线教程"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://runoob.com/"</span>,</span><br><span class="line">          name:<span class="string">"菜鸟教程"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://segmentfault.com/"</span>,</span><br><span class="line">          name:<span class="string">"思否社区"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          url:<span class="string">"https://jianshu.com/"</span>,</span><br><span class="line">          name:<span class="string">"简书"</span>,</span><br><span class="line">          desc:<span class="string">"程序员集散地"</span></span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> el = <span class="function">(<span class="params">tag, attrs, content</span>) =&gt;</span> <span class="string">`&lt;<span class="subst">$&#123;tag&#125;</span> <span class="subst">$&#123;attrs.join(<span class="string">" "</span>)&#125;</span>&gt;<span class="subst">$&#123;content&#125;</span>&lt;/<span class="subst">$&#123;tag&#125;</span>&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> init = &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'content-type'</span>: <span class="string">'text/html;charset=UTF-8'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(renderHTML(renderIndex(),config.selling_ads? renderSeller() :<span class="literal">null</span>), init);</span><br><span class="line">&#125;</span><br><span class="line">addEventListener(<span class="string">'fetch'</span>, event =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> event.respondWith(handleRequest(event.request))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*通过分析链接 实时获取favicon</span></span><br><span class="line"><span class="comment">* @url 需要分析的Url地址</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFavicon</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(url.match(<span class="regexp">/https&#123;0,1&#125;:\/\//</span>))&#123;</span><br><span class="line">    <span class="comment">//return "https://ui-avatars.com/api/?bold=true&amp;size=36&amp;background=0D8ABC&amp;color=fff&amp;rounded=true&amp;name=" + url.split('//')[1];</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://www.google.cn/s2/favicons?sz=64&amp;domain_url="</span> + url;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//return "https://ui-avatars.com/api/?bold=true&amp;size=36&amp;background=0D8ABC&amp;color=fff&amp;rounded=true&amp;name=" + url;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://www.google.cn/s2/favicons?sz=64&amp;domain_url=http://"</span> + url;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Render Functions</span></span><br><span class="line"><span class="comment"> *  渲染模块函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderIndex</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> footer = el(<span class="string">'footer'</span>,[],el(<span class="string">'div'</span>,[<span class="string">'class="footer"'</span>],<span class="string">'Powered by'</span> + el(<span class="string">'a'</span>,[<span class="string">'class="ui label"'</span>,<span class="string">'href="https://github.com/sleepwood/cf-worker-dir"'</span>,<span class="string">'target="_blank"'</span>],el(<span class="string">'i'</span>,[<span class="string">'class="github icon"'</span>],<span class="string">""</span>) + <span class="string">'Cf-Worker-Dir'</span>) + <span class="string">' &amp;copy; Base on '</span> + el(<span class="string">'a'</span>,[<span class="string">'class="ui label"'</span>],el(<span class="string">'i'</span>,[<span class="string">'class="balance scale icon"'</span>],<span class="string">""</span>) + <span class="string">'MIT License'</span>)));</span><br><span class="line">  <span class="keyword">return</span> renderHeader() + renderMain() + footer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderHeader</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="function">(<span class="params">template,name</span>) =&gt;</span> el(<span class="string">'a'</span>,[<span class="string">'class="item"'</span>,<span class="string">`data-url="<span class="subst">$&#123;template&#125;</span>"`</span>],name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> nav = el(<span class="string">'div'</span>,[<span class="string">'class="ui large secondary inverted menu"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="item"'</span>],el(<span class="string">'p'</span>,[<span class="string">'id="hitokoto"'</span>],<span class="string">'条条大路通罗马'</span>)))</span><br><span class="line">  <span class="keyword">var</span> title = el(<span class="string">'h1'</span>,[<span class="string">'class="ui inverted header"'</span>],el(<span class="string">'i'</span>,[<span class="string">`class="<span class="subst">$&#123;config.logo_icon&#125;</span> icon"`</span>],<span class="string">""</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="content"'</span>],config.title + el(<span class="string">'div'</span>,[<span class="string">'class="sub header"'</span>],config.subtitle)));</span><br><span class="line">  <span class="keyword">var</span> menu = el(<span class="string">'div'</span>,[<span class="string">'id="sengine"'</span>,<span class="string">'class="ui bottom attached tabular inverted secondary menu"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="header item"'</span>],<span class="string">'&amp;nbsp;'</span>) + config.search_engine.map(<span class="function">(<span class="params">link,key</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> el(<span class="string">'a'</span>,[<span class="string">'class="active item"'</span>,<span class="string">`data-url="<span class="subst">$&#123;link.template&#125;</span>"`</span>],link.name);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> item(link.template,link.name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).join(<span class="string">""</span>))</span><br><span class="line">  <span class="keyword">var</span> input = el(<span class="string">'div'</span>,[<span class="string">'class="ui left corner labeled right icon fluid large input"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui left corner label"'</span>],el(<span class="string">'img'</span>,[<span class="string">'id="search-fav"'</span>,<span class="string">'class="left floated avatar ui image"'</span>,<span class="string">'src="https://www.baidu.com/favicon.ico"'</span>],<span class="string">""</span>)) + el(<span class="string">'input'</span>,[<span class="string">'id="searchinput"'</span>,<span class="string">'type="search"'</span>,<span class="string">'placeholder="搜索你想要知道的……"'</span>,<span class="string">'autocomplete="off"'</span>],<span class="string">""</span>) + el(<span class="string">'i'</span>,[<span class="string">'class="inverted circular search link icon"'</span>],<span class="string">""</span>));</span><br><span class="line">  <span class="keyword">return</span> el(<span class="string">'header'</span>,[],el(<span class="string">'div'</span>,[<span class="string">'id="head"'</span>,<span class="string">'class="ui inverted vertical masthead center aligned segment"'</span>],(config.hitokoto ? el(<span class="string">'div'</span>,[<span class="string">'id="nav"'</span>,<span class="string">'class="ui container"'</span>],nav) : <span class="string">""</span>) + el(<span class="string">'div'</span>,[<span class="string">'id="title"'</span>,<span class="string">'class="ui text container"'</span>],title + (config.search ? input + menu :<span class="string">""</span>) + <span class="string">`<span class="subst">$&#123;config.selling_ads ? <span class="string">'&lt;div&gt;&lt;a id="menubtn" class="red ui icon inverted button"&gt;&lt;i class="heart icon"&gt;&lt;/i&gt; 喜欢此域名 &lt;/a&gt;&lt;/div&gt;'</span> : <span class="string">''</span>&#125;</span>`</span>)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderMain</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> main = config.lists.map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> card = <span class="function">(<span class="params">url,name,desc</span>)=&gt;</span> el(<span class="string">'a'</span>,[<span class="string">'class="card"'</span>,<span class="string">`href=<span class="subst">$&#123;url&#125;</span>`</span>,<span class="string">'target="_blank"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="content"'</span>],el(<span class="string">'img'</span>,[<span class="string">'class="left floated avatar ui image"'</span>,<span class="string">`src=<span class="subst">$&#123;getFavicon(url)&#125;</span>`</span>],<span class="string">""</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="header"'</span>],name) + el(<span class="string">'div'</span>,[<span class="string">'class="meta"'</span>],desc)));</span><br><span class="line">    <span class="keyword">const</span> divider = el(<span class="string">'h4'</span>,[<span class="string">'class="ui horizontal divider header"'</span>],el(<span class="string">'i'</span>,[<span class="string">`class="<span class="subst">$&#123;item.icon&#125;</span> icon"`</span>],<span class="string">""</span>)+item.name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> content = el(<span class="string">'div'</span>,[<span class="string">'class="ui four stackable cards"'</span>],item.list.map(<span class="function">(<span class="params">link</span>) =&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> card(link.url,link.name,link.desc);</span><br><span class="line">    &#125;).join(<span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> el(<span class="string">'div'</span>,[<span class="string">'class="ui basic segment"'</span>],divider + content);</span><br><span class="line">  &#125;).join(<span class="string">""</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> el(<span class="string">'main'</span>,[],el(<span class="string">'div'</span>,[<span class="string">'class="ui container"'</span>],main));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderSeller</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="function">(<span class="params">type,content</span>) =&gt;</span> el(<span class="string">'div'</span>,[<span class="string">'class="item"'</span>],el(<span class="string">'i'</span>,[<span class="string">`class="<span class="subst">$&#123;type&#125;</span> icon"`</span>],<span class="string">""</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="content"'</span>],content));</span><br><span class="line">  <span class="keyword">var</span> title = el(<span class="string">'h1'</span>,[<span class="string">'class="ui yellow dividing header"'</span>],el(<span class="string">'i'</span>,[<span class="string">'class="gem outline icon"'</span>],<span class="string">""</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="content"'</span>],config.sell_info.domain + <span class="string">' 正在出售'</span>));</span><br><span class="line">  <span class="keyword">var</span> action = el(<span class="string">'div'</span>,[<span class="string">'class="actions"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui basic cancel inverted button"'</span>],el(<span class="string">'i'</span>,[<span class="string">'class="reply icon"'</span>],<span class="string">""</span>) + <span class="string">'返回'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> contact = config.sell_info.contact.map(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> item(list.type,list.content);</span><br><span class="line">  &#125;).join(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">var</span> column = el(<span class="string">'div'</span>,[<span class="string">'class="column"'</span>],el(<span class="string">'h3'</span>,[<span class="string">'class="ui center aligned icon inverted header"'</span>],el(<span class="string">'i'</span>,[<span class="string">'class="circular envelope open outline grey inverted icon"'</span>],<span class="string">""</span>) + <span class="string">'联系我'</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="ui relaxed celled large list"'</span>],contact));</span><br><span class="line">  <span class="keyword">var</span> price = el(<span class="string">'div'</span>,[<span class="string">'class="column"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui large yellow statistic"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="value"'</span>],el(<span class="string">'i'</span>,[<span class="string">`class="<span class="subst">$&#123;config.sell_info.mon_unit&#125;</span> icon"`</span>],<span class="string">""</span>) + config.sell_info.price)));</span><br><span class="line">  <span class="keyword">var</span> content = el(<span class="string">'div'</span>,[<span class="string">'class="content"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui basic segment"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui two column stackable center aligned grid"'</span>],el(<span class="string">'div'</span>,[<span class="string">'class="ui inverted vertical divider"'</span>],<span class="string">'感兴趣？'</span>) + el(<span class="string">'div'</span>,[<span class="string">'class="middle aligned row"'</span>],price + column))));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> el(<span class="string">'div'</span>,[<span class="string">'id="seller"'</span>,<span class="string">'class="ui basic modal"'</span>],title + content + action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderHTML</span>(<span class="params">index,seller</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">  &lt;html lang="en"&gt;</span></span><br><span class="line"><span class="string">  &lt;head&gt;</span></span><br><span class="line"><span class="string">      &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">      &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span></span><br><span class="line"><span class="string">      &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</span></span><br><span class="line"><span class="string">      &lt;title&gt;<span class="subst">$&#123;config.title&#125;</span> - <span class="subst">$&#123;config.subtitle&#125;</span>&lt;/title&gt;</span></span><br><span class="line"><span class="string">      &lt;link href="https://cdn.jsdelivr.net/npm/semantic-ui-css@2.4.1/semantic.min.css" rel="stylesheet"&gt;</span></span><br><span class="line"><span class="string">      &lt;link href="https://cdn.jsdelivr.net/gh/sleepwood/cf-worker-dir@0.1.1/style.css" rel="stylesheet"&gt;</span></span><br><span class="line"><span class="string">      &lt;script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;script src="https://cdn.jsdelivr.net/npm/semantic-ui-css@2.4.1/semantic.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;body&gt;</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;index&#125;</span></span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;config.selling_ads ? seller : <span class="string">''</span>&#125;</span></span></span><br><span class="line"><span class="string">    &lt;script src="https://v1.hitokoto.cn/?encode=js&amp;select=%23hitokoto" defer&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">      $('#sengine a').on('click', function (e) &#123;</span></span><br><span class="line"><span class="string">        $('#sengine a.active').toggleClass('active');</span></span><br><span class="line"><span class="string">        $(e.target).toggleClass('active');</span></span><br><span class="line"><span class="string">        $('#search-fav').attr('src',$(e.target).data('url').match(`</span>+<span class="regexp">/https&#123;0,1&#125;:\/\/\S+\//</span>+<span class="string">`)[0] + '/favicon.ico') ;</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      $('.search').on('click', function (e) &#123;</span></span><br><span class="line"><span class="string">          var url = $('#sengine a.active').data('url');</span></span><br><span class="line"><span class="string">          url = url.replace(`</span>+<span class="regexp">/\$s/</span>+<span class="string">`,$('#searchinput').val());</span></span><br><span class="line"><span class="string">          window.open(url);</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      /* 鼠标聚焦时，回车事件 */</span></span><br><span class="line"><span class="string">      $("#searchinput").bind("keypress", function()&#123;</span></span><br><span class="line"><span class="string">          if (event.keyCode == 13)&#123;</span></span><br><span class="line"><span class="string">          // 触发需要调用的方法</span></span><br><span class="line"><span class="string">          $(".search").click();</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      $('#menubtn').on('click', function (e) &#123;</span></span><br><span class="line"><span class="string">          $('#seller').modal('show');</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &lt;/html&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div>
<p>详细步骤见:<a href="https://url.cn/06D9xM3j" target="_blank" rel="noopener">https://url.cn/06D9xM3j</a><br>最终效果如图↓<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers-dir.jpg" width = "60%" /></p>
<h3 id="直链解析"><a href="#直链解析" class="headerlink" title="直链解析"></a>直链解析</h3><blockquote>
<p>源地址已无从考究。。。<br>以后找到再更新吧<br>该源码可以解析google drive/蓝奏云/119网盘的直链地址</p>
</blockquote>
<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> googleDriveCtrl = <span class="keyword">async</span> (ctx , view) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> id = ctx.params.id</span><br><span class="line">  <span class="keyword">const</span> host = <span class="string">'https://drive.google.com/'</span></span><br><span class="line">  <span class="keyword">let</span> result = &#123; id &#125;</span><br><span class="line">  <span class="comment">//if( ctx.query.output == 'json' )&#123;</span></span><br><span class="line">  <span class="keyword">let</span> resp = <span class="keyword">await</span> request.get(<span class="string">`<span class="subst">$&#123;host&#125;</span>file/d/<span class="subst">$&#123;id&#125;</span>/view`</span>)</span><br><span class="line">  result.name = (resp.body.match(<span class="regexp">/&lt;meta\s+property="og:title"\s+content="([^"]+)"/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>]</span><br><span class="line">  result.ext = (result.name.match(<span class="regexp">/\.([0-9a-z]+)$/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span>(resp.body.indexOf(<span class="string">'errorMessage'</span>) &gt;=<span class="number">0</span> ) <span class="keyword">return</span> result</span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> downloadUrl = <span class="string">''</span></span><br><span class="line">  <span class="keyword">let</span> code = (resp.body.match(<span class="regexp">/viewerData\s*=\s*(\&#123;[\w\W]+?\&#125;);&lt;\/script&gt;/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">let</span> preview_url = <span class="string">''</span></span><br><span class="line">  code = code.replace(<span class="regexp">/[\r\n]/g</span>,<span class="string">''</span>).replace(<span class="regexp">/'/g</span>,<span class="string">'"'</span>)</span><br><span class="line">    .replace(<span class="string">'config'</span>,<span class="string">'"config"'</span>)</span><br><span class="line">    .replace(<span class="string">'configJson'</span>,<span class="string">'"configJson"'</span>)</span><br><span class="line">    .replace(<span class="string">'itemJson'</span>,<span class="string">'"itemJson"'</span>)</span><br><span class="line">    .replace(<span class="regexp">/,\&#125;/g</span>,<span class="string">'&#125;'</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\x22/g</span>,<span class="string">'"'</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\x27/g</span>,<span class="string">"'"</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\x5b/g</span>,<span class="string">'['</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\x5d/g</span>,<span class="string">']'</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\(r|n)/g</span>,<span class="string">''</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\\\u/g</span>,<span class="string">'\\u'</span>).toString(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(code)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      code = <span class="built_in">JSON</span>.parse(code)</span><br><span class="line">      <span class="comment">//获取码率</span></span><br><span class="line">      <span class="comment">// 37/1920x1080/9/0/115, </span></span><br><span class="line">      <span class="comment">// "size|url,size|url"</span></span><br><span class="line">      <span class="keyword">const</span> rates = &#123;&#125; , urls = []</span><br><span class="line">      code.itemJson[<span class="number">19</span>][<span class="number">0</span>][<span class="number">15</span>][<span class="number">1</span>].split(<span class="string">','</span>).forEach(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> [c,_,r] = i.split(<span class="regexp">/[\/x]/</span>)</span><br><span class="line">        rates[c] = <span class="built_in">parseInt</span>(r)</span><br><span class="line">      &#125;)</span><br><span class="line">      code.itemJson[<span class="number">19</span>][<span class="number">0</span>][<span class="number">18</span>][<span class="number">1</span>].split(<span class="string">','</span>).forEach( <span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> [rate , url] = i.split(<span class="string">'|'</span>)</span><br><span class="line">        urls.push(&#123;<span class="attr">size</span>:rates[rate] , <span class="attr">url</span>:<span class="built_in">decodeURIComponent</span>(url)&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      result.urls = urls.sort(<span class="function">(<span class="params">a,b</span>)=&gt;</span>a.size&lt;b.size?<span class="number">1</span>:<span class="number">-1</span>)</span><br><span class="line">      result.size = <span class="built_in">parseInt</span>(code.itemJson[<span class="number">25</span>][<span class="number">2</span>])</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(ctx.query.output == <span class="string">'media'</span>)</span><br><span class="line">    result.cookie = resp.headers[<span class="string">'set-cookie'</span>]</span><br><span class="line">  <span class="keyword">let</span> &#123; body , headers , redirected , url &#125;= <span class="keyword">await</span> request.get(<span class="string">`<span class="subst">$&#123;host&#125;</span>uc?id=<span class="subst">$&#123;id&#125;</span>&amp;export=download`</span>,&#123;<span class="attr">headers</span>: ctx.req.headers , <span class="attr">redirect</span>:<span class="string">'manual'</span>&#125;)</span><br><span class="line">  <span class="keyword">if</span>(headers[<span class="string">'location'</span>])&#123;</span><br><span class="line">    downloadUrl = headers[<span class="string">'location'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//大文件下载提示</span></span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(body.indexOf(<span class="string">'Too many users'</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">      <span class="keyword">let</span> url = (body.match(<span class="regexp">/uc\?export=download[^"']+/i</span>) || [<span class="string">''</span>])[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">let</span> cookie = headers[<span class="string">'set-cookie'</span>]</span><br><span class="line">      <span class="keyword">let</span> resp = <span class="keyword">await</span> request.get(host + url.replace(<span class="regexp">/&amp;amp;/g</span>,<span class="string">'&amp;'</span>) , &#123;<span class="attr">headers</span>:&#123;cookie&#125; , <span class="attr">redirect</span>:<span class="string">'manual'</span>&#125;)</span><br><span class="line">      <span class="keyword">if</span>(resp.headers[<span class="string">'location'</span>] )&#123;</span><br><span class="line">        downloadUrl = resp.headers[<span class="string">'location'</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      result.message = <span class="string">'Too many users have viewed or downloaded this file recently'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  result.url = downloadUrl.replace(<span class="string">'?e=download'</span>,<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lanzouCtrl = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> id = ctx.params.id</span><br><span class="line">  <span class="keyword">const</span> host = <span class="string">'https://www.lanzous.com'</span></span><br><span class="line">  <span class="keyword">const</span> newHeaders = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>:<span class="string">'Mozilla/5.0 (Linux; Android 6.0) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/37.0.0.0 Mobile Safari/537.36 MicroMessenger/6.3.25.861'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> result = &#123; id &#125;</span><br><span class="line">  <span class="keyword">let</span> &#123; body &#125;  = <span class="keyword">await</span> request.get(<span class="string">`<span class="subst">$&#123;host&#125;</span>/tp/<span class="subst">$&#123;id&#125;</span>`</span> , &#123;<span class="attr">headers</span>:&#123;...newHeaders , <span class="attr">referrer</span>:<span class="string">''</span>&#125;&#125;)</span><br><span class="line">  <span class="keyword">let</span> url = (body.match(<span class="regexp">/(?&lt;=dpost\s*\+\s*["']\?)[^"']+/</span>) || [<span class="literal">false</span>])[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> base = (body.match(<span class="regexp">/(?&lt;=urlp[^\=]*=\s*')[^']+/</span>)|| [<span class="literal">false</span>])[<span class="number">0</span>]</span><br><span class="line">  result.name = (body.match(<span class="regexp">/(?&lt;="md"&gt;)[^&lt;]+/</span>) || [<span class="string">''</span>])[<span class="number">0</span>].replace(<span class="regexp">/\s*$/</span>,<span class="string">''</span>)</span><br><span class="line">  result.ext = (result.name.match(<span class="regexp">/\.([0-9a-z]+)$/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span>(url &amp;&amp; base) result.url = base + <span class="string">'?'</span> + url</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> joyCtrl = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> id = ctx.params.id</span><br><span class="line">  <span class="keyword">const</span> host = atob(<span class="string">'aHR0cDovL3d3dy45MXBvcm4uY29t'</span>)</span><br><span class="line">  <span class="keyword">const</span> rnd = <span class="function">(<span class="params">min , max</span>) =&gt;</span> <span class="built_in">Math</span>.floor(min+<span class="built_in">Math</span>.random()*(max-min))</span><br><span class="line">  <span class="keyword">const</span> ip = rnd(<span class="number">50</span>,<span class="number">250</span>) + <span class="string">"."</span> + rnd(<span class="number">50</span>,<span class="number">250</span>) + <span class="string">"."</span> + rnd(<span class="number">50</span>,<span class="number">250</span>)+ <span class="string">"."</span> + rnd(<span class="number">50</span>,<span class="number">250</span>)</span><br><span class="line">  <span class="keyword">const</span> newHeaders = &#123;</span><br><span class="line">    <span class="string">'PHPSESSID'</span>:<span class="string">'fff'</span>,</span><br><span class="line">    <span class="string">'CLIENT-IP'</span>:ip,</span><br><span class="line">    <span class="string">'HTTP_X_FORWARDED_FOR'</span>:ip,</span><br><span class="line">    <span class="string">'user-agent'</span>:ctx.req.headers.get(<span class="string">'user-agent'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> decodeUrl = <span class="keyword">async</span> (body) =&gt; &#123;</span><br><span class="line">    <span class="comment">// eval / new Function is not allowed for security reasons. </span></span><br><span class="line">    <span class="comment">// let scrs = await request.get(`$&#123;host&#125;/js/md5.js`)</span></span><br><span class="line">    ;<span class="keyword">var</span> encode_version = <span class="string">'sojson.v5'</span>, lbbpm = <span class="string">'__0x33ad7'</span>,  __0x33ad7=[<span class="string">'QMOTw6XDtVE='</span>,<span class="string">'w5XDgsORw5LCuQ=='</span>,<span class="string">'wojDrWTChFU='</span>,<span class="string">'dkdJACw='</span>,<span class="string">'w6zDpXDDvsKVwqA='</span>,<span class="string">'ZifCsh85fsKaXsOOWg=='</span>,<span class="string">'RcOvw47DghzDuA=='</span>,<span class="string">'w7siYTLCnw=='</span>];(<span class="function"><span class="keyword">function</span>(<span class="params">_0x94dee0,_0x4a3b74</span>)</span>&#123;<span class="keyword">var</span> _0x588ae7=<span class="function"><span class="keyword">function</span>(<span class="params">_0x32b32e</span>)</span>&#123;<span class="keyword">while</span>(--_0x32b32e)&#123;_0x94dee0[<span class="string">'push'</span>](_0x94dee0[<span class="string">'shift'</span>]());&#125;&#125;;_0x588ae7(++_0x4a3b74);&#125;(__0x33ad7,<span class="number">0x8f</span>));<span class="keyword">var</span> _0x5b60=<span class="function"><span class="keyword">function</span>(<span class="params">_0x4d4456,_0x5a24e3</span>)</span>&#123;_0x4d4456=_0x4d4456<span class="number">-0x0</span>;<span class="keyword">var</span> _0xa82079=__0x33ad7[_0x4d4456];<span class="keyword">if</span>(_0x5b60[<span class="string">'initialized'</span>]===<span class="literal">undefined</span>)&#123;(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> _0xef6e0=<span class="keyword">typeof</span> <span class="built_in">window</span>!==<span class="string">'undefined'</span>?<span class="built_in">window</span>:<span class="keyword">typeof</span> process===<span class="string">'object'</span>&amp;&amp;<span class="keyword">typeof</span> <span class="built_in">require</span>===<span class="string">'function'</span>&amp;&amp;<span class="keyword">typeof</span> global===<span class="string">'object'</span>?global:<span class="keyword">this</span>;<span class="keyword">var</span> _0x221728=<span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='</span>;_0xef6e0[<span class="string">'atob'</span>]||(_0xef6e0[<span class="string">'atob'</span>]=<span class="function"><span class="keyword">function</span>(<span class="params">_0x4bb81e</span>)</span>&#123;<span class="keyword">var</span> _0x1c1b59=<span class="built_in">String</span>(_0x4bb81e)[<span class="string">'replace'</span>](<span class="regexp">/=+$/</span>,<span class="string">''</span>);<span class="keyword">for</span>(<span class="keyword">var</span> _0x5e3437=<span class="number">0x0</span>,_0x2da204,_0x1f23f4,_0x3f19c1=<span class="number">0x0</span>,_0x3fb8a7=<span class="string">''</span>;_0x1f23f4=_0x1c1b59[<span class="string">'charAt'</span>](_0x3f19c1++);~_0x1f23f4&amp;&amp;(_0x2da204=_0x5e3437%<span class="number">0x4</span>?_0x2da204*<span class="number">0x40</span>+_0x1f23f4:_0x1f23f4,_0x5e3437++%<span class="number">0x4</span>)?_0x3fb8a7+=<span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](<span class="number">0xff</span>&amp;_0x2da204&gt;&gt;(<span class="number">-0x2</span>*_0x5e3437&amp;<span class="number">0x6</span>)):<span class="number">0x0</span>)&#123;_0x1f23f4=_0x221728[<span class="string">'indexOf'</span>](_0x1f23f4);&#125;<span class="keyword">return</span> _0x3fb8a7;&#125;);&#125;());<span class="keyword">var</span> _0x43712e=<span class="function"><span class="keyword">function</span>(<span class="params">_0x2e9442,_0x305a3a</span>)</span>&#123;<span class="keyword">var</span> _0x3702d8=[],_0x234ad1=<span class="number">0x0</span>,_0xd45a92,_0x5a1bee=<span class="string">''</span>,_0x4a894e=<span class="string">''</span>;_0x2e9442=atob(_0x2e9442);<span class="keyword">for</span>(<span class="keyword">var</span> _0x67ab0e=<span class="number">0x0</span>,_0x1753b1=_0x2e9442[<span class="string">'length'</span>];_0x67ab0e&lt;_0x1753b1;_0x67ab0e++)&#123;_0x4a894e+=<span class="string">'%'</span>+(<span class="string">'00'</span>+_0x2e9442[<span class="string">'charCodeAt'</span>](_0x67ab0e)[<span class="string">'toString'</span>](<span class="number">0x10</span>))[<span class="string">'slice'</span>](<span class="number">-0x2</span>);&#125;_0x2e9442=<span class="built_in">decodeURIComponent</span>(_0x4a894e);<span class="keyword">for</span>(<span class="keyword">var</span> _0x246dd5=<span class="number">0x0</span>;_0x246dd5&lt;<span class="number">0x100</span>;_0x246dd5++)&#123;_0x3702d8[_0x246dd5]=_0x246dd5;&#125;<span class="keyword">for</span>(_0x246dd5=<span class="number">0x0</span>;_0x246dd5&lt;<span class="number">0x100</span>;_0x246dd5++)&#123;_0x234ad1=(_0x234ad1+_0x3702d8[_0x246dd5]+_0x305a3a[<span class="string">'charCodeAt'</span>](_0x246dd5%_0x305a3a[<span class="string">'length'</span>]))%<span class="number">0x100</span>;_0xd45a92=_0x3702d8[_0x246dd5];_0x3702d8[_0x246dd5]=_0x3702d8[_0x234ad1];_0x3702d8[_0x234ad1]=_0xd45a92;&#125;_0x246dd5=<span class="number">0x0</span>;_0x234ad1=<span class="number">0x0</span>;<span class="keyword">for</span>(<span class="keyword">var</span> _0x39e824=<span class="number">0x0</span>;_0x39e824&lt;_0x2e9442[<span class="string">'length'</span>];_0x39e824++)&#123;_0x246dd5=(_0x246dd5+<span class="number">0x1</span>)%<span class="number">0x100</span>;_0x234ad1=(_0x234ad1+_0x3702d8[_0x246dd5])%<span class="number">0x100</span>;_0xd45a92=_0x3702d8[_0x246dd5];_0x3702d8[_0x246dd5]=_0x3702d8[_0x234ad1];_0x3702d8[_0x234ad1]=_0xd45a92;_0x5a1bee+=<span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](_0x2e9442[<span class="string">'charCodeAt'</span>](_0x39e824)^_0x3702d8[(_0x3702d8[_0x246dd5]+_0x3702d8[_0x234ad1])%<span class="number">0x100</span>]);&#125;<span class="keyword">return</span> _0x5a1bee;&#125;;_0x5b60[<span class="string">'rc4'</span>]=_0x43712e;_0x5b60[<span class="string">'data'</span>]=&#123;&#125;;_0x5b60[<span class="string">'initialized'</span>]=!![];&#125;<span class="keyword">var</span> _0x4be5de=_0x5b60[<span class="string">'data'</span>][_0x4d4456];<span class="keyword">if</span>(_0x4be5de===<span class="literal">undefined</span>)&#123;<span class="keyword">if</span>(_0x5b60[<span class="string">'once'</span>]===<span class="literal">undefined</span>)&#123;_0x5b60[<span class="string">'once'</span>]=!![];&#125;_0xa82079=_0x5b60[<span class="string">'rc4'</span>](_0xa82079,_0x5a24e3);_0x5b60[<span class="string">'data'</span>][_0x4d4456]=_0xa82079;&#125;<span class="keyword">else</span>&#123;_0xa82079=_0x4be5de;&#125;<span class="keyword">return</span> _0xa82079;&#125;;<span class="keyword">if</span>(<span class="keyword">typeof</span> encode_version!==<span class="string">'undefined'</span>&amp;&amp;encode_version===<span class="string">'sojson.v5'</span>)&#123;<span class="function"><span class="keyword">function</span> <span class="title">strencode</span>(<span class="params">_0x50cb35,_0x1e821d</span>)</span>&#123;<span class="keyword">var</span> _0x59f053=&#123;<span class="string">'MDWYS'</span>:<span class="string">'0|4|1|3|2'</span>,<span class="string">'uyGXL'</span>:<span class="function"><span class="keyword">function</span> <span class="title">_0x3726b1</span>(<span class="params">_0x2b01e8,_0x53b357</span>)</span>&#123;<span class="keyword">return</span> _0x2b01e8(_0x53b357);&#125;,<span class="string">'otDTt'</span>:<span class="function"><span class="keyword">function</span> <span class="title">_0x4f6396</span>(<span class="params">_0x33a2eb,_0x5aa7c9</span>)</span>&#123;<span class="keyword">return</span> _0x33a2eb&lt;_0x5aa7c9;&#125;,<span class="string">'tPPtN'</span>:<span class="function"><span class="keyword">function</span> <span class="title">_0x3a63ea</span>(<span class="params">_0x1546a9,_0x3fa992</span>)</span>&#123;<span class="keyword">return</span> _0x1546a9%_0x3fa992;&#125;&#125;;<span class="keyword">var</span> _0xd6483c=_0x59f053[_0x5b60(<span class="string">'0x0'</span>,<span class="string">'cEiQ'</span>)][_0x5b60(<span class="string">'0x1'</span>,<span class="string">'&amp;]Gi'</span>)](<span class="string">'|'</span>),_0x1a3127=<span class="number">0x0</span>;<span class="keyword">while</span>(!![])&#123;<span class="keyword">switch</span>(_0xd6483c[_0x1a3127++])&#123;<span class="keyword">case</span><span class="string">'0'</span>:_0x50cb35=_0x59f053[_0x5b60(<span class="string">'0x2'</span>,<span class="string">'ofbL'</span>)](atob,_0x50cb35);<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">'1'</span>:code=<span class="string">''</span>;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">'2'</span>:<span class="keyword">return</span> _0x59f053[_0x5b60(<span class="string">'0x3'</span>,<span class="string">'mLzQ'</span>)](atob,code);<span class="keyword">case</span><span class="string">'3'</span>:<span class="keyword">for</span>(i=<span class="number">0x0</span>;_0x59f053[_0x5b60(<span class="string">'0x4'</span>,<span class="string">'J2rX'</span>)](i,_0x50cb35[_0x5b60(<span class="string">'0x5'</span>,<span class="string">'Z(CX'</span>)]);i++)&#123;k=_0x59f053[<span class="string">'tPPtN'</span>](i,len);code+=<span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](_0x50cb35[_0x5b60(<span class="string">'0x6'</span>,<span class="string">'s4(u'</span>)](i)^_0x1e821d[<span class="string">'charCodeAt'</span>](k));&#125;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">'4'</span>:len=_0x1e821d[_0x5b60(<span class="string">'0x7'</span>,<span class="string">'!Mys'</span>)];<span class="keyword">continue</span>;&#125;<span class="keyword">break</span>;&#125;&#125;&#125;<span class="keyword">else</span>&#123;alert(<span class="string">''</span>);&#125;;</span><br><span class="line">    <span class="keyword">let</span> args = (body.match(<span class="regexp">/(?&lt;=strencode\()[^\)]+/</span>) || [<span class="string">''</span>])[<span class="number">0</span>]</span><br><span class="line">      .split(<span class="string">','</span>)</span><br><span class="line">      .map( <span class="function"><span class="params">i</span> =&gt;</span> i.replace(<span class="regexp">/(^"|"$)/g</span>,<span class="string">''</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> source = strencode.apply(<span class="literal">null</span> , args) , url = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span>(source)&#123;</span><br><span class="line">      url = (source.match(<span class="regexp">/src\s*=\s*["']([^"']+)/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> &#123; body &#125; = <span class="keyword">await</span> request.get(<span class="string">`<span class="subst">$&#123;host&#125;</span>/view_video.php?viewkey=<span class="subst">$&#123;id&#125;</span>`</span>, &#123;<span class="attr">headers</span>:newHeaders&#125;)</span><br><span class="line">  <span class="keyword">let</span> result = &#123; id &#125;</span><br><span class="line">  result.name =(body.match(<span class="regexp">/viewvideo-title"&gt;([^&lt;]+)/</span>) || [<span class="string">''</span>,<span class="string">''</span>])[<span class="number">1</span>].replace(<span class="regexp">/[\r\n]/g</span>,<span class="string">''</span>).replace(<span class="regexp">/(^[\s]*|[\s]*$)/g</span>,<span class="string">''</span>)</span><br><span class="line">  result.ext = <span class="string">'mp4'</span></span><br><span class="line">  result.url = <span class="keyword">await</span> decodeUrl(body)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 辅助 fetch</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> request = &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">get</span>(url , options = &#123;&#125;)&#123;</span><br><span class="line">    <span class="keyword">let</span> mergeOptions = &#123;</span><br><span class="line">      ...options,</span><br><span class="line">      method:<span class="string">'GET'</span>,</span><br><span class="line">      headers:<span class="built_in">Object</span>.assign( &#123;&#125; , options.headers || &#123;&#125; )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( mergeOptions.headers[<span class="string">'cookie'</span>] )&#123;</span><br><span class="line">      mergeOptions.redentials = <span class="string">'include'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( mergeOptions.body )&#123;</span><br><span class="line">      mergeOptions.body = <span class="built_in">JSON</span>.stringify(mergeOptions.body);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( mergeOptions.json )&#123;</span><br><span class="line">      mergeOptions.headers[<span class="string">'accept'</span>] = <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(url , mergeOptions)</span><br><span class="line">    <span class="keyword">if</span>(mergeOptions.raw === <span class="literal">true</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> resp = &#123; ...response , <span class="attr">headers</span>:&#123;&#125; &#125;</span><br><span class="line">    <span class="keyword">if</span>(response.headers)&#123;</span><br><span class="line">      <span class="keyword">let</span> headers = &#123;&#125;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> response.headers.keys())&#123;</span><br><span class="line">        headers[i] = response.headers.get(i)</span><br><span class="line">      &#125;</span><br><span class="line">      resp.headers = headers</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( mergeOptions.json === <span class="literal">true</span> )&#123;</span><br><span class="line">      resp.body = <span class="keyword">await</span> response.json()</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      resp.body = <span class="keyword">await</span> response.text()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> utils = &#123;</span><br><span class="line">  isPlainObject(obj)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">'object'</span> || obj === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> proto = obj</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">Object</span>.getPrototypeOf(proto) !== <span class="literal">null</span>) &#123;</span><br><span class="line">      proto = <span class="built_in">Object</span>.getPrototypeOf(proto)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.getPrototypeOf(obj) === proto</span><br><span class="line">  &#125;,</span><br><span class="line">  isType(v, type)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call( v ) === <span class="string">`[object <span class="subst">$&#123;type&#125;</span>]`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  getRange(r , total)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!r) <span class="keyword">return</span> [<span class="number">0</span> , total<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">let</span> [, start, end] = r.match(<span class="regexp">/(\d*)-(\d*)/</span>) || [];</span><br><span class="line">    start = start ? <span class="built_in">parseInt</span>(start) : <span class="number">0</span></span><br><span class="line">    end = end ? <span class="built_in">parseInt</span>(end) : total - <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> [start , end]</span><br><span class="line">  &#125;,</span><br><span class="line">  parserHeaders(headers)&#123;</span><br><span class="line">    <span class="keyword">let</span> ret = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> pair <span class="keyword">of</span> headers.entries())&#123;</span><br><span class="line">      ret[pair[<span class="number">0</span>].toLowerCase()] = pair[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 迷你框架 ctx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(event)&#123;</span><br><span class="line">    <span class="keyword">let</span> req = <span class="keyword">new</span> URL(event.request.url)</span><br><span class="line">    <span class="keyword">let</span> query = &#123;&#125; , params = &#123;&#125; , headers = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> pair <span class="keyword">of</span> req.searchParams.entries()) &#123;</span><br><span class="line">      query[pair[<span class="number">0</span>]] = pair[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> pair <span class="keyword">of</span> event.request.headers.entries())&#123;</span><br><span class="line">      headers[pair[<span class="number">0</span>].toLowerCase()] = pair[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.event = event</span><br><span class="line">    <span class="keyword">this</span>.query = query</span><br><span class="line">    <span class="keyword">this</span>.params = params</span><br><span class="line">    <span class="keyword">this</span>.querystring = req.search</span><br><span class="line">    <span class="keyword">this</span>.pathname = req.pathname</span><br><span class="line">    <span class="keyword">this</span>.method = event.request.method</span><br><span class="line">    <span class="keyword">this</span>.host = req.host</span><br><span class="line">    <span class="keyword">this</span>.protocol = req.protocol</span><br><span class="line">    <span class="keyword">this</span>.headers = <span class="keyword">this</span>.header = headers</span><br><span class="line">    <span class="keyword">this</span>._resHeaders = &#123; &#125;</span><br><span class="line">    <span class="keyword">this</span>._status = <span class="number">200</span></span><br><span class="line">    <span class="keyword">this</span>._data = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span>(key , value)&#123;</span><br><span class="line">    <span class="keyword">this</span>._resHeaders[key] = value</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> res()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.event.respondWith</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> req()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.event.request</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> status(code)&#123;</span><br><span class="line">    <span class="keyword">this</span>._status = code</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> data()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._data</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> body(data)&#123;</span><br><span class="line">    <span class="keyword">if</span>( utils.isType(data , <span class="string">'Promise'</span>))&#123;</span><br><span class="line">      <span class="comment">//get readableStream object and merge haders</span></span><br><span class="line">      <span class="keyword">this</span>._data = data.then(<span class="function"><span class="params">r</span> =&gt;</span> <span class="keyword">new</span> Response(r.body , &#123;</span><br><span class="line">        status:<span class="keyword">this</span>._status,</span><br><span class="line">        headers:&#123;...utils.parserHeaders(r.headers),...this._resHeaders&#125;</span><br><span class="line">      &#125;)).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//this._data = new Response(data , &#123;status:this._status,headers:this._headers&#125;)</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(utils.isPlainObject(data))&#123;</span><br><span class="line">      data = <span class="built_in">JSON</span>.stringify(data)</span><br><span class="line">      <span class="keyword">this</span>.set(<span class="string">'Content-Type'</span>,<span class="string">"application/json"</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.set(<span class="string">'Content-Type'</span>,<span class="string">"text/html; charset=utf-8"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>._data = <span class="keyword">new</span> Response(data , &#123;<span class="attr">status</span>:<span class="keyword">this</span>._status,<span class="attr">headers</span>:<span class="keyword">this</span>._resHeaders&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  redirect(url,code = <span class="number">302</span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>._data = Response.redirect( url.replace(<span class="regexp">/^\//</span>,<span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.protocol&#125;</span>//<span class="subst">$&#123;<span class="keyword">this</span>.host&#125;</span>/`</span>) , code)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 迷你框架，内置路由中间件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.routes = []</span><br><span class="line">    <span class="keyword">this</span>.middlewares = []</span><br><span class="line">  &#125;</span><br><span class="line">  use(<span class="built_in">module</span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>.middlewares.push( <span class="built_in">module</span> )</span><br><span class="line">  &#125;</span><br><span class="line">  listen()&#123;</span><br><span class="line">    addEventListener(<span class="string">'fetch'</span>, event =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> ctx = <span class="keyword">new</span> Context(event)</span><br><span class="line">      event.respondWith(<span class="keyword">this</span>.process(ctx))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> process(ctx)&#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.compose([].concat(<span class="keyword">this</span>.middlewares , <span class="keyword">this</span>._routerMiddleware.bind(<span class="keyword">this</span>)))(ctx);</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'&gt;&gt;&gt;'</span>,<span class="keyword">typeof</span> ctx.data)</span><br><span class="line">    <span class="keyword">return</span> ctx.data</span><br><span class="line">  &#125;</span><br><span class="line">  router(method , expr , handler)&#123;</span><br><span class="line">    <span class="keyword">this</span>.routes.push( &#123; ...this._routeToReg(expr) , <span class="attr">method</span>:method.toUpperCase() , handler&#125; )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> _routerMiddleware(ctx , next)&#123;</span><br><span class="line">    <span class="keyword">let</span> params = &#123;&#125; , handler</span><br><span class="line">    <span class="keyword">let</span> &#123; pathname , method &#125; = ctx</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> route <span class="keyword">of</span> <span class="keyword">this</span>.routes)&#123;</span><br><span class="line">      <span class="keyword">if</span>( route.method == method )&#123;</span><br><span class="line">        <span class="keyword">let</span> hit = route.expr.exec( pathname )</span><br><span class="line">        <span class="keyword">if</span>( hit )&#123;</span><br><span class="line">          hit = hit.slice(<span class="number">1</span>)</span><br><span class="line">          route.key.forEach(<span class="function">(<span class="params">i , idx</span>) =&gt;</span> &#123;</span><br><span class="line">            params[i] = hit[idx]</span><br><span class="line">          &#125;)</span><br><span class="line">          handler = route.handler</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.params = params</span><br><span class="line">    <span class="keyword">if</span>(handler) <span class="keyword">await</span> handler(ctx)</span><br><span class="line">    <span class="keyword">return</span> next()</span><br><span class="line">  &#125;</span><br><span class="line">  _routeToReg(route)&#123;</span><br><span class="line">    <span class="keyword">let</span> optionalParam = <span class="regexp">/\((.*?)\)/g</span> ,</span><br><span class="line">        namedParam    = <span class="regexp">/(\(\?)?:\w+/g</span>,</span><br><span class="line">        splatParam    = <span class="regexp">/\*\w+/g</span>,</span><br><span class="line">        escapeRegExp  = <span class="regexp">/[\-&#123;&#125;\[\]+?.,\\\^$|#\s]/g</span>;</span><br><span class="line">    <span class="keyword">let</span> route_new = route.replace(escapeRegExp, <span class="string">'\\$&amp;'</span>)</span><br><span class="line">        .replace(optionalParam, <span class="string">'(?:$1)?'</span>)</span><br><span class="line">        .replace(namedParam, <span class="function"><span class="keyword">function</span>(<span class="params">match, optional</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> optional ? match : <span class="string">'([^/?]+)'</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">        .replace(splatParam, <span class="string">'([^?]*?)'</span>);</span><br><span class="line">    <span class="keyword">let</span> expr = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'^'</span> + route_new + <span class="string">'(?:\\?([\\s\\S]*))?$'</span>);</span><br><span class="line">    <span class="keyword">let</span> res = expr.exec(route).slice(<span class="number">1</span>)</span><br><span class="line">    res.pop()</span><br><span class="line">    <span class="keyword">return</span> &#123; expr , <span class="attr">key</span>: res.map( <span class="function"><span class="params">i</span> =&gt;</span> i.replace(<span class="regexp">/^\:/</span>,<span class="string">''</span>))&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  compose(middlewares) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">context</span>) =&gt;</span> middlewares.reduceRight( <span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve(b(context,a)), () =&gt; &#123;&#125;)(context)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 视图中间件，仅用于此项目</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> View = <span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">ctx , next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( ctx.render ) <span class="keyword">return</span> next()</span><br><span class="line">    ctx.render = <span class="keyword">async</span> (data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> type = ctx.query.output</span><br><span class="line">      <span class="keyword">if</span>( !data.url )&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">        <span class="keyword">if</span>( type == <span class="string">'json'</span>)&#123;</span><br><span class="line">          ctx.body = &#123;<span class="attr">status</span> : <span class="number">-1</span> , <span class="attr">message</span> : <span class="string">"error"</span> , ...data&#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          ctx.body = data.message || <span class="string">'404'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(type == <span class="string">'json'</span>)&#123;</span><br><span class="line">          ctx.body = &#123;<span class="attr">status</span> : <span class="number">0</span>, <span class="attr">result</span>:data&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">'redirect'</span>)&#123;</span><br><span class="line">          ctx.redirect( data.url )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">'preview'</span>)&#123;</span><br><span class="line">          <span class="keyword">if</span>( [<span class="string">'mp3'</span>,<span class="string">'ogg'</span>,<span class="string">'m4a'</span>,<span class="string">'acc'</span>].includes(data.ext))&#123;</span><br><span class="line">            ctx.body = <span class="string">`&lt;audio src=<span class="subst">$&#123;data.url&#125;</span> controls autoplay&gt;&lt;/autio&gt;`</span></span><br><span class="line">          &#125;<span class="keyword">else</span> <span class="keyword">if</span>( [<span class="string">'mp4'</span>, <span class="string">'mkv'</span> , <span class="string">'webm'</span>].includes(data.ext) )&#123;</span><br><span class="line">            ctx.body = <span class="string">`&lt;video src=<span class="subst">$&#123;data.url&#125;</span> controls autoplay&gt;&lt;/video&gt;`</span></span><br><span class="line">          &#125;<span class="keyword">else</span> <span class="keyword">if</span>( [<span class="string">'jpg'</span>,<span class="string">'jpeg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>,<span class="string">'bmp'</span>].includes(data.ext))&#123;</span><br><span class="line">            ctx.body = <span class="string">`&lt;img src="<span class="subst">$&#123;data.url&#125;</span>"&gt;`</span></span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ctx.body = <span class="string">'无法预览'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">'media'</span>)&#123;</span><br><span class="line">          <span class="keyword">if</span>(data.urls)&#123;</span><br><span class="line">            <span class="keyword">let</span> rawHeaders = ctx.req.headers</span><br><span class="line">            <span class="keyword">let</span> headers = <span class="keyword">new</span> Headers()</span><br><span class="line">            headers.append(<span class="string">'cookie'</span> , data.cookie)</span><br><span class="line">            ;[<span class="string">'range'</span>].forEach(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span>( rawHeaders.has(i))&#123;</span><br><span class="line">                headers.append(i , rawHeaders.get(i))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            ctx.body = fetch(data.urls[<span class="number">0</span>].url , &#123;headers&#125;)</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ctx.body = <span class="string">'404'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">// ref https://community.cloudflare.com/t/a-valid-host-header-must-be-supplied-to-reach-the-desired-website/48569/3</span></span><br><span class="line">          <span class="comment">// Workers’ implementation of fetch() does not currently support fetching directly from an IP address at all. </span></span><br><span class="line">          <span class="keyword">if</span>( <span class="regexp">/\:\/\/[\.\d]+/</span>.test(data.url))&#123;</span><br><span class="line">            ctx.redirect( data.url )</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// if(data.size)&#123;</span></span><br><span class="line">            <span class="comment">//   ctx.set('accept-ranges','bytes')</span></span><br><span class="line">            <span class="comment">//   let headers = ctx.headers</span></span><br><span class="line">            <span class="comment">//   if(ctx.headers['range'])&#123;</span></span><br><span class="line">            <span class="comment">//     let [start , end] = utils.getRange(ctx.headers['range'] , data.size)</span></span><br><span class="line">            <span class="comment">//     ctx.set('content-range', `bytes $&#123;start&#125;-$&#123;end&#125;/$&#123;data.size&#125;`)</span></span><br><span class="line">            <span class="comment">//     ctx.set('content-length', end - start + 1)</span></span><br><span class="line">            <span class="comment">//     headers.range = `bytes=$&#123;start&#125;-$&#123;end&#125;`</span></span><br><span class="line">            <span class="comment">//     ctx.status = 206</span></span><br><span class="line">            <span class="comment">//   &#125;else&#123;</span></span><br><span class="line">            <span class="comment">//     ctx.set('content-range', `bytes 0-$&#123;data.size-1&#125;/$&#123;data.size&#125;`)</span></span><br><span class="line">            <span class="comment">//     headers.range = `bytes=0-`</span></span><br><span class="line">            <span class="comment">//   &#125;</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="comment">// console.log(ctx.headers)</span></span><br><span class="line">            <span class="keyword">let</span> headers = ctx.headers</span><br><span class="line">            <span class="keyword">if</span>(data.size)&#123;</span><br><span class="line">              ctx.status = <span class="number">206</span></span><br><span class="line">              ctx.set(<span class="string">'accept-range'</span>,<span class="string">'bytes'</span>)</span><br><span class="line">               <span class="keyword">if</span>(!headers[<span class="string">'range'</span>])&#123;</span><br><span class="line">              <span class="comment">// headers.Range = 'bytes=0-2180577102'</span></span><br><span class="line">              ctx.set(<span class="string">'content-length'</span>,data.size)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx.set(<span class="string">'accept-range'</span>,<span class="string">'bytes'</span>)</span><br><span class="line">            ctx.body = fetch(data.url , &#123;headers&#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> App()</span><br><span class="line">app.use( View() )</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span>,<span class="string">'/gd/:id'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.render( <span class="keyword">await</span> googleDriveCtrl(ctx) )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span>,<span class="string">'/gda/:id'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.render( <span class="keyword">await</span> googleDriveCtrl(ctx) )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span> , <span class="string">'/lanzou/:id'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.render( <span class="keyword">await</span> lanzouCtrl(ctx) )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span> , <span class="string">'/19/:id'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.render( <span class="keyword">await</span> joyCtrl(ctx) )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span> , <span class="string">'/link/:id'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> id = ctx.params.id , count = id.length</span><br><span class="line">  <span class="keyword">let</span> vendors = &#123;<span class="number">28</span>:<span class="string">'gd'</span>, <span class="number">20</span>:<span class="string">'19'</span>, <span class="number">33</span>:<span class="string">'gd'</span>, <span class="number">7</span>:<span class="string">'lanzou'</span>&#125;</span><br><span class="line">  ctx.redirect( vendors[count] ? <span class="string">`/<span class="subst">$&#123;vendors[count]&#125;</span>/<span class="subst">$&#123;id&#125;</span><span class="subst">$&#123;ctx.querystring&#125;</span>`</span> : <span class="string">'/'</span> )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.router(<span class="string">'get'</span>,<span class="string">'/'</span> , <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">`&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="Content-Type"content="text/html; charset=utf-8"&gt;&lt;title&gt;LINK&lt;/title&gt;&lt;style&gt;body&#123;font-family:-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Roboto,Arial,PingFang SC,Hiragino Sans GB,Microsoft Yahei,Microsoft Jhenghei,sans-serif&#125;&lt;/style&gt;&lt;style&gt;section&#123;width:650px;background:0 0;position:absolute;top:35%;transform:translate(-50%,-50%);left:50%;color:rgba(0,0,0,.85);font-size:14px;text-align:center&#125;input&#123;box-sizing:border-box;height:48px;width:100%;padding:11px 16px;font-size:16px;color:#404040;background-color:#fff;border:2px solid#ddd;transition:border-color ease-in-out.15s,box-shadow ease-in-out.15s;margin-bottom:24px&#125;button&#123;position:relative;display:inline-block;font-weight:400;white-space:nowrap;text-align:center;box-shadow:0 2px 0 rgba(0,0,0,.015);cursor:pointer;transition:all.3s cubic-bezier(.645,.045,.355,1);user-select:none;border-radius:4px;line-height:1em;background-color:#f2f2f2;border:1px solid#f2f2f2;min-width:100px;color:#5F6368;font-size:14px;padding:12px;margin:0 6px;outline:none&#125;button:hover&#123;border:1px solid#c6c6c6;background-color:#f8f8f8&#125;h4&#123;font-size:24px;margin-bottom:48px;text-align:center;color:rgba(0,0,0,.7);font-weight:400&#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;section&gt;&lt;h4&gt;直链下载&lt;/h4&gt;&lt;input value=""id="q"name="q"type="text"placeholder="文件ID (GoogleDrive / Lanzou / 19)"/&gt;&lt;button onClick="handleDownload()"&gt;下载&lt;/button&gt;&lt;button onClick="handleDownload('preview')"&gt;预览&lt;/button&gt;&lt;button onClick="handleDownload('json')"&gt;JSON&lt;/button&gt;&lt;button onClick="handleDownload('media')"&gt;转码播放(仅限Google)&lt;/button&gt;&lt;/section&gt;&lt;script&gt;function handleDownload(output)&#123;var id=document.querySelector('#q').value;if(id)window.open('/link/'+id+(output?'?output='+output:''))&#125;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;`</span></span><br><span class="line">&#125;)</span><br><span class="line">app.listen()</span><br></pre></td></tr></table></figure>
</div></div>


<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></div>

<h3 id="加速下载"><a href="#加速下载" class="headerlink" title="加速下载"></a>加速下载</h3><blockquote>
<p>功能:使用 cloudflare 的全球 CDN 加速下载文件<br>github:<a href="https://url.cn/RFxZwgoS" target="_blank" rel="noopener">https://url.cn/RFxZwgoS</a></p>
</blockquote>
<div><div class="fold_hider"><div class="close hider_title">点击显/隐内容</div></div><div class="fold">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">** 功能：使用 cloudflare 全球 CDN 加速下载文件</span></span><br><span class="line"><span class="comment">** 使用：</span></span><br><span class="line"><span class="comment">**   - 将代码拷贝到 cloudflare workers Script</span></span><br><span class="line"><span class="comment">**   - xxxxx.xxxx.workers.dev/?durl=要下载的文件直链</span></span><br><span class="line"><span class="comment">***</span></span><br><span class="line"><span class="comment">** 注意：如果下载链接中包含有特殊字符，先 encodeURI</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">addEventListener(</span><br><span class="line">  <span class="string">"fetch"</span>,event =&gt; &#123;</span><br><span class="line">    event.respondWith(</span><br><span class="line">      handleRequest(event.request)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求下载文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;web Request&#125;</span> </span>request 网络请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;web Response&#125;</span>        </span>请求结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> url=<span class="keyword">new</span> URL(request.url)</span><br><span class="line">  <span class="keyword">let</span> durl=url.searchParams.get(<span class="string">'durl'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (durl) &#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="built_in">decodeURI</span>(durl))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> init = &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'content-type'</span>: <span class="string">'text/plain;charset=UTF-8'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">`</span></span><br><span class="line"><span class="string">    无下载链接，请添加 GET 参数 durl： </span></span><br><span class="line"><span class="string">      xxxxx.xxxx.workers.dev/?durl=要下载的文件直链</span></span><br><span class="line"><span class="string">    without downloadurl, please make sure there is a "durl" GET parameter: </span></span><br><span class="line"><span class="string">      xxxxx.xxxx.workers.dev/?durl=downloadurl</span></span><br><span class="line"><span class="string">    Tip: 如果下载链接比较复杂，建议先 encodeURI</span></span><br><span class="line"><span class="string">    反馈 issue： https://github.com/hitop/CFWorkers</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(data, init)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div>

<h3 id="GDIndex"><a href="#GDIndex" class="headerlink" title="GDIndex"></a>GDIndex</h3><blockquote>
<p>功能:使用cloudflare实现免**下载/上传google drive文件<br>github:<a href="https://github.com/maple3142/GDIndex" target="_blank" rel="noopener">https://github.com/maple3142/GDIndex</a><br>相关限制:cloudflare限制最大上传大小为100MB<br>workers每日请求量100000</p>
</blockquote>
<p>首先打开 <a href="https://gdindex-code-builder.glitch.me/" target="_blank" rel="noopener">https://gdindex-code-builder.glitch.me/</a><br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/GDIndex Code Builder.jpg" width = "60%" /></p>
<p>点击<code>Click me</code>按钮,会跳转到谷歌的登录页面(访问不了的自行解决)<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/google.jpg" width = "60%" /><br>点击<code>允许</code><br>这时会出现一串代码，复制下来，粘贴到原网页的<code>Authorization Code</code><br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/code.jpg" width = "60%" /><br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/paste.jpg" width = "60%" /></p>
<p><code>Default Root ID</code>: 填写目录ID，如图所示，默认为根目录<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/root_id.jpg" width = "60%" /><br>如果想要设置密码访问的话，可以勾选<code>Enable authentication</code>,然后设置用户名和密码<br>想要进行上传的话，可以勾选<code>Enable file uploading</code><br>最后点击<code>Get Code</code>，生成代码后，复制到workers中，保存并部署即可</p>
<p>最终效果如下↓<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/GDIndex.jpg" width = "60%" /></p>
<h2 id="自定义域名"><a href="#自定义域名" class="headerlink" title="自定义域名"></a>自定义域名</h2><p>将你想自定义的域名CNAME指向workers的域名<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers-domain.jpg" width = "60%" /><br>这里有两种情况<br>1.使用cloudflare ns接入的<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/cf-dns.jpg" width = "60%" /><br>2.使用第三方平台接入的(如:<a href="https://cdn.wzfou.com/" target="_blank" rel="noopener">https://cdn.wzfou.com/</a>)<br>点击<code>添加新记录</code>,跳转到如下界面<br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/wzf.jpg" width = "60%" /></p>
<p>dns解析设置完成后，回到cloudflare控制面板，点击<code>workers -&gt; 添加路由</code><br><img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/workers.jpg" width = "60%" /></p>
<img data-src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/posts/cf-workers/set.jpg" width = "60%" />

<p>设置完成，点<code>保存</code>即可</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>原创不易，您的支持将鼓励我继续创作！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/wechatpay.jpg" alt="Ravi 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/alipay.png" alt="Ravi 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Ravi
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.ravi.cool/posts/cf-workers.html" title="cf-workers的使用">https://www.ravi.cool/posts/cf-workers.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Cloudflare/" rel="tag"># Cloudflare</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/%E7%A8%8B%E5%BA%8F%E5%AE%9A%E5%88%B6.html" rel="prev" title="程序定制">
      <i class="fa fa-chevron-left"></i> 程序定制
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/make-github-faster.html" rel="next" title="make-github-faster">
      make-github-faster <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#what’s-cf-workers"><span class="nav-number">1.</span> <span class="nav-text">what’s cf-workers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用方法"><span class="nav-number">2.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例代码"><span class="nav-number">3.</span> <span class="nav-text">示例代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#workers-proxy"><span class="nav-number">3.1.</span> <span class="nav-text">workers-proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jsproxy"><span class="nav-number">3.2.</span> <span class="nav-text">jsproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CF-Worker-Dir"><span class="nav-number">3.3.</span> <span class="nav-text">CF-Worker-Dir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#直链解析"><span class="nav-number">3.4.</span> <span class="nav-text">直链解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加速下载"><span class="nav-number">3.5.</span> <span class="nav-text">加速下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GDIndex"><span class="nav-number">3.6.</span> <span class="nav-text">GDIndex</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义域名"><span class="nav-number">4.</span> <span class="nav-text">自定义域名</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ravi</p>
  <div class="site-description" itemprop="description">一个充满知识的地方</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ravizhan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ravizhan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ravizhan@ravi.cool" title="E-Mail → mailto:ravizhan@ravi.cool" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/wechat.jpg" title="WeChat → https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;ravizhan&#x2F;ravizhan.github.io&#x2F;wechat.jpg" rel="noopener" target="_blank"><i class="fa fa-fw fa-wechat"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=2876473037&site=qq&menu=yes" title="QQ → http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;2876473037&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ravi</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">5k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4 分钟</span>
</div>
<div>
<span id="sitetime"></span>
<script language=javascript>
    function siteTime(){
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth()+1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        var t1 = Date.UTC(2020,7,7,00,00,00); //北京时间2016-12-1 00:00:00
        var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
        var diff = t2-t1;
        var diffYears = Math.floor(diff/years);
        var diffDays = Math.floor((diff/days)-diffYears*365);
        var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
        var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
        var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
        document.getElementById("sitetime").innerHTML=" 已运行"+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
    }
    siteTime();
</script>
</div>
<div>
</div>
<div id="cc-myssl-id" style="position: fixed;right: 0;bottom: 0;width: 65px;height: 65px;z-index: 99;">
    <a href="https://myssl.com/www.ravi.cool?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id.png" alt="" style="width:100%;height:100%"></a>
</div>
<canvas class="fireworks"style="position:fixed;left:0;top:0;z-index:99999999;pointer-events:none;"></canvas>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ravizhan/css-js@master/baozatexiao.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>

        








      </div>
    </footer>
  </div>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script>

<script src="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/js/utils.js"></script>

<script src="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/js/motion.js"></script>


<script src="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/js/schemes/pisces.js"></script>


<script src="//cdn.jsdelivr.net/gh/ravizhan/ravizhan.github.io/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>















    <div id="pjax">
  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://www.ravi.cool/posts/cf-workers.html',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'gij1kjp4VDaHO2LFc0iRcWFi-gzGzoHsz',
      appKey     : 'AtayWFiqtjMpjQPewVcfnMNT',
      placeholder: "说点什么吧",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
